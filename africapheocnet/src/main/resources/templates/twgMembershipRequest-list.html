<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="header :: head"></head>
<head>
    <!-- Add Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.7.0/dist/css/bootstrap.min.css">
    
    <!-- Add DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

    <!-- Add jQuery and DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.6/js/dataTables.bootstrap5.min.js"></script>

</head>
<body data-topbar="dark">
    <header th:replace="header :: page-topbar"></header>
    <div th:replace="sidebar :: menu"></div>

   <div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="row">
            
                <div class="col-lg-12">
                    <div class="card">
                            <div class="card-header justify-content-between d-flex align-items-center">
							    <h4 class="card-title">Membership Requests</h4>
							    <div class ="row">
							    
							    
							    <div class="col-md-3">
								    <div class="input-group">
								        <span class="input-group-text"><i class="fas fa-filter"></i></span>
								        <select id="statusFilter" class="form-select" aria-label="Status Filter">
								            <option value="">All Status</option>
								            <option th:each="status : ${T(net.pheocnetafr.africapheocnet.util.AutoFilledData).getTwgGroupStatusList()}"
								                th:value="${status}" th:text="${status}"></option>
								        </select>
								    </div>
								</div>
								
								<div class="col-md-3">
								    <div class="input-group">
								       <span class="input-group-text"><i class="fas fa-users"></i></span>
								        <select id="groupFilter" class="form-select" aria-label="Group Filter">
								            <option value="">All Groups</option>
								            <option th:each="group : ${T(net.pheocnetafr.africapheocnet.util.AutoFilledData).getTwgGroupList()}"
								                th:value="${group}" th:text="${group}"></option>
								        </select>
								    </div>
								</div>
								<div class="col-md-3">
								    <button id="exportExcelBtn" class="btn btn-success">
								        <i class="fas fa-file-excel"></i> Export to Excel
								    </button>
								</div>
							    
							    
							    </div>
							    
																
								
							    
						</div>
						
                        <div class="card-body">
                         <div id="alertBox" class="alert alert-warning alert-top-border alert-dismissible fade show" role="alert" style="display: none;">
								    <i class="uil uil-exclamation-triangle font-size-16 text-warning me-2"></i>
								   <span class="alert-message">A simple border warning alert</span>
								    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
						</div>
						<div class="table-responsive" >
                       <table class="hover" id="dbdata">
    <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col">ID</th>
            <th scope="col">First Name</th>
            <th scope="col">Last Name</th>
            <th scope="col">Position</th>
            <th scope="col">Organization</th>
            <th scope="col">Country</th>
            <th scope="col">Group</th>
            <th scope="col">Status</th>
            <th scope="col">Action</th>
        </tr>
    </thead>
    <tbody>
        <tr th:each="request, iterStat : ${membershipRequests}">
            <td th:text="${iterStat.count}">...</td>
            <td th:text="${request.id}">...</td>
            <td th:text="${request.firstName}">...</td>
            <td th:text="${request.lasttName}">...</td>
            <td th:text="${request.position}">...</td>
            <td th:text="${request.organization}">...</td>
            <td th:text="${request.nationality}">...</td>
            <td th:text="${request.twg}">...</td>
            <td>
			    <span th:text="${request.status}" th:class="${request.status eq 'Approved' ? 'badge rounded-pill badge-soft-success' : (request.status eq 'Pending' ? 'badge rounded-pill badge-soft-warning' : 'badge rounded-pill badge-soft-danger')}"></span>
			</td>
			<td>
		        
		        <div th:if="${request.status == 'Pending'}" class="d-flex flex-wrap gap-2">
		            <button type="button" class="btn btn-outline-success approve-btn" th:data-request-id="${request.id}">
		                <i class="uil uil-check-circle"></i> 
		            </button>
		            <button type="button" class="btn btn-outline-danger reject-btn" th:data-request-id="${request.id}">
					    <i class="uil uil-ban"></i> 
					</button>
		            
		        </div>
		        <div th:if="${request.status == 'Approved'}">
		            <button type="button" class="btn btn-outline-dark btn-rounded revoke-btn" th:data-request-id="${request.id}">Revoke</button>
		        </div>
		    </td>
		    
            
        </tr>
        <script>

        document.addEventListener("DOMContentLoaded", function () {
            var approveButtons = document.querySelectorAll('.approve-btn');
            var rejectButtons = document.querySelectorAll('.reject-btn');
            var revokeButtons = document.querySelectorAll('.revoke-btn');

            approveButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var requestId = button.getAttribute('data-request-id');
                    console.log('Request ID for approve:', requestId);
                    approveRequest(requestId);
                });
            });

            rejectButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var requestId = button.getAttribute('data-request-id');
                    console.log('Request ID for reject:', requestId);
                    rejectRequest(requestId);
                });
            });

            revokeButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var requestId = button.getAttribute('data-request-id');
                    console.log('Request ID for revoke:', requestId);
                    revokeRequest(requestId);
                });
            });

            function approveRequest(requestId) {
                // Obtain CSRF token from meta tags
                var csrfToken = $("meta[name='_csrf']").attr("content");
                var csrfHeader = $("meta[name='_csrf_header']").attr("content");

                fetch('/twg-membership-requests/approve/' + requestId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    }
                })
                .then(function(response) {
                    if (response.ok) {
                        showAlert('success', 'Request approved successfully.');
                    } else {
                        showAlert('warning', 'Failed to approve request.');
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    showAlert('error', 'An error occurred while processing the request.');
                });
            }

            function rejectRequest(requestId) {
                // Obtain CSRF token from meta tags
                var csrfToken = $("meta[name='_csrf']").attr("content");
                var csrfHeader = $("meta[name='_csrf_header']").attr("content");

                fetch('/twg-membership-requests/reject/' + requestId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    }
                })
                .then(function(response) {
                    if (response.ok) {
                        showAlert('success', 'Request rejected successfully.');
                    } else {
                        showAlert('error', 'Failed to reject request.');
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    showAlert('error', 'An error occurred while processing the request.');
                });
            }

            function revokeRequest(requestId) {
                // Obtain CSRF token from meta tags
                var csrfToken = $("meta[name='_csrf']").attr("content");
                var csrfHeader = $("meta[name='_csrf_header']").attr("content");

                fetch('/twg-membership-requests/revoke/' + requestId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    }
                })
                .then(function(response) {
                    if (response.ok) {
                        showAlert('success', 'Request revoked successfully.');
                    } else {
                        showAlert('error', 'Failed to revoke request.');
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    showAlert('error', 'An error occurred while processing the request.');
                });
            }
        });

		
		</script>
        
        
    </tbody>
</table>

                        </div>
                        <!-- end card body -->
                    </div>
                    <!-- end card -->
                </div>
                <!-- end col -->
            </div>
        </div>
    </div>
</div>
</div>
   
    
    <footer th:replace="footer :: footer-content"></footer>
    <footer th:replace="rightbar :: right-bar"></footer>
    
     <!-- JAVASCRIPT -->
	<script th:src="@{/libs/bootstrap/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/libs/metismenujs/metismenujs.min.js}"></script>
	<script th:src="@{/libs/simplebar/simplebar.min.js}"></script>
	<script th:src="@{/libs/feather-icons/feather.min.js}"></script>
	
	
	
	<!-- swiper js -->
	<script th:src="@{/libs/swiper/swiper-bundle.min.js}"></script>
	<script th:src="@{/libs/@ckeditor/ckeditor5-build-classic/build/ckeditor.js}"></script>
	
	<script th:src="@{/js/pages/email-editor.init.js}"></script>
	
	
	<script th:src="@{/js/app.js}"></script>
	
	
	<script>
  new DataTable('#dbdata');
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var exportExcelBtn = document.getElementById('exportExcelBtn');
        var statusFilter = document.getElementById('statusFilter');
        var groupFilter = document.getElementById('groupFilter');

        exportExcelBtn.addEventListener('click', exportToExcel);
        statusFilter.addEventListener('change', filterTable);
        groupFilter.addEventListener('change', filterTable);

        function exportToExcel() {
            var table = document.getElementById('dbdata');
            var html = table.outerHTML;

            var blob = new Blob([html], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });

            var url = URL.createObjectURL(blob);

            var a = document.createElement('a');
            a.href = url;
            a.download = 'twg_applications_data.xlsx'; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }


        function filterTable() {
            var selectedStatus = statusFilter.value;
            var selectedGroup = groupFilter.value;
            var tableRows = document.querySelectorAll('#dbdata tbody tr');

            tableRows.forEach(function (row) {
                var statusCell = row.querySelector('td:nth-child(9)');
                var groupCell = row.querySelector('td:nth-child(8)');
                var rowStatus = statusCell.textContent.trim();
                var rowGroup = groupCell.textContent.trim();

                var statusMatch = selectedStatus === '' || rowStatus === selectedStatus;
                var groupMatch = selectedGroup === '' || rowGroup === selectedGroup;

                if (statusMatch && groupMatch) {
                    row.style.display = 'table-row';
                } else {
                    row.style.display = 'none';
                }
            });
        }
    });
</script>


</body>
</html>
